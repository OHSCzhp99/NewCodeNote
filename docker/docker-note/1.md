## Docker
---
### 1. Docker是什么
```java
Docker 可以打包应用以及依赖包 到一个轻量级、可移植的容器中，
然后发布到任何流行的 Linux 机器上，也可以实现虚拟化。

容器：是实例，例如应用node容器、redis容器等
```

### 2. Docker安装
```java
1.安装依赖包：yum install -y yum-utils device-mapper-persistent-data lvm2
2.设置阿里云镜像源：yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
3.安装docker：yum install -y docker-ce
4.启动docker命令：systemctl start docker
设置开机自启命令：systemctl enable docker
查看docker版本命令：docker version
5.创建docker配置文件目录：mkdir -p /etc/docker 
添加配置内容：
tee /etc/docker/daemon.json <<-'EOF'
 {
  "registry-mirrors": ["https://vsxcs7sq.mirror.aliyuncs.com"]
}
EOF
重启docker：systemctl restart docker
6.安装可视化Portainer：
搜索镜像：docker search portainer
拉取镜像命令：docker pull portainer/portainer
查看镜像命令：docker images
创建数据卷：docker volume create portainer_data
启动容器：docker run -d -p 9000:9000 --restart=always --name prtainer -v /var/run/docker.sock:/var/run/docker.sock -v portainer_data:/data portainer/portainer
查看启动中的容器：docker ps
7.访问可视化客户端：http://192.168.121:120:9000 ip地址要换自己的
```
检验是否安装成功：`docker -v`  
查看 docker 镜像：`docker images` (前提是已经启动了docker服务，用sudo权限)  

启动 docker：`systemctl start docker`  
关闭 docker：`systemctl stop docker`  
重启 docker：`systemctl restart docker`  
设置开机自启：`systemctl enable docker`  

### 3. Docker 运行 Mysql
```java
docker run -d \
  --name mysql \
  -p 3306:3306 \
  -e TZ=Asia/Shanghai \
  -e MYSQL_ROOT_PASSWORD=123 \
  mysql
```
-d 代表后台运行  
-p 代表端口映射，前面是宿主机可以随便更改（集群会不一样），后面是真实的端口  
-e KEY=VALUE 是设置环境变量  
mysql 是镜像名字也可以冒号跟版本号 :14

### 4. 常见命令
```java
docker从镜像仓库（dockerhub）拉取镜像到 本地镜像
```
拉取镜像 `docker pull`  
查看本地镜像 `docker images`  
删除本地镜像 `docker rmi`  
打包镜像 `docker build`  
上传镜像 `docker push`  

创建容器并运行 `docker run`  （会创建容器，但不对一个容器重复使用run）  
停止容器运行 `docker stop` （容器还在，只是停止运行了）   
停止后重启容器 `docker start`（不会创建容器）   
容器运行情况 `docker ps`  
删除容器 `docker rm`  
容器日志 `docker logs`  
修改进入容器 `docker exec`

### 5. 实践步骤
1.在 DockerHub 中搜索 Nginx 镜像，查看镜像的名称  
2.拉取Nginx镜像 `docker pull nginx`  
3.查看本地镋像列表 `docker images`  
4.创建并运行Nginx容器 `docker run -d --name nginx -p 80:80 ngix`  
5.查看容器 `docker ps`  
6.停止容器 `docker stop nginx`  
7.再次启动容器  `docker start nginx`  
8.进入Nginx容器 `docker exec -it mysql bash`（-it是终端、bash是命令行）  
9.删除容器 `docker rm nginx -f`（-f是强制）

### 6. 数据卷挂载
```java
因为不能直接修改容器里面的内容，通过数据卷，能够进行宿主机文件系统和容器文件的映射
而挂载则是产生映射关联，即绑定
宿主机文件系统：/var/lib/docker/volumes/  
```
1.查看数据卷 `docker volume ls`   
2.数据卷详情 `docker volume inspect`   
"Mountpoint" 表示宿主机的映射路径

### 7. 容器网络互连
```java
创建自定义网络，可以通过容器名字让容器互相访问
```
1.创建自定义网络，名字为cookingnw `docker network create cookingnw`  
2.查看网络有哪些（看有没有cookingnw） `docker network ls`  
3.将容器加入网络（将mysql容器加入cookingnw） `docker network connect cookingnw mysql`  
4.查看mysql容器的网络 `docker inspect mysql`

### 8.1 部署 - Mysql
Mysql部署：  
1.先把本地数据库导入到docker容器中（容器名字为mysql）  
`docker cp (sql文件路径) mysql:.` （把sql文件拖入到mysql容器中的数据卷init）  
2.通过命令行的方式进入mysql容器  
`docker exec -it mysql bash`  
`mysql -uroot -proot`  （mysql容器中的用户名和密码）  
3.导入sql文件（不用路径了）
`source (sql文件名)`  
4.将上面第7节的内容（容器网络互连，把mysql加入到自定义网络中）

### 8.2 部署 - Springboot
```java
1.在springboot项目中的resources文件下创建额外两个application文件
因为打包部署到docker是链接docker中mysql的容器，不是本地数据库

application-dev.yaml：
#开发环境链接数据库的变量
cooking:
  db:
    host: mysql
    pw: root

application-local.yaml：
#本地连接数据库的变量
cooking:
  db:
    host: 127.0.0.1
    pw: root

application.yaml:
spring:
  profiles:
    active: dev //要部署到docker这里改为dev
  datasource:
    url: jdbc:mysql://${cooking.db.host}:3306/cooking
    省略...
```
Springboot部署：
