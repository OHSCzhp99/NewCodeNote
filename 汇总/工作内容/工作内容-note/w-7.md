## ivr语音 - asterisk平台
---

### 1. 配置文件
总目录：/usr/local/asterisk-18.22.0  

配置 分机号码 文件：sip.conf   
`vim /usr/local/asterisk-18.22.0/etc/asterisk/sip.conf`  

配置 拨号计划 文件：extensions.conf   
`vim /usr/local/asterisk-18.22.0/etc/asterisk/extensions.conf`  

调用外部程序接口目录：agi-bin  
`cd /usr/local/asterisk-18.22.0/var/lib/asterisk/agi-bin`  

### 2. asterisk 控制台
1.进入控制台：  
`asterisk -r`  进入控制台  
`asterisk -rvvv`  进入控制台（实时滚屏详细信息）  

2.重新加载配置文件：  
`sip reload` 重新载入 分机号码 sip.conf   
`dialplan reload` 重新载入 拨号计划 extensions.conf  

3.常用命令：  
`sip show peers` 查看分机号  
`sip show users`  查看用户/密码  
`sip show channelstats` 查看抖动  


### 3. 拨号计划 - 上下文
1.基本结构：（扩展、优先级、执行动作）  
[context]  
exten => extension,priority,action  

2.比如：
```
exten => _600X,1,Verbose(1,Caller ${CALLERID(all)} ------->> ${EXTEN})
 same => n,Playback(/root/connecting)
 same => n,Dial(SIP/${EXTEN},30)
 same => n,Hangup()

扩展：
exten => _600X 
优先级：
1/n/n/n （在实际运行中就是1/2/3/4这样）
执行动作：
Verbose()/Playback()/Dial()/Hangup()
```

### 4. 拨号计划 - 动作命令
1.打印日志：Verbose()  
```
将会在asterisk日志输出：
exten => _600X,1,Verbose(1,This is a test message)
```

2.播放音频：Playback()  
```
播放音频 给 呼叫方：
same => n,Playback(/root/connecting)
```

3.呼叫：Dial()  
```
使用指定的技术（如SIP）呼叫一个资源（如分机、电话号码等），30是超时时间：
same => n,Dial(SIP/${EXTEN},30)
```

4.设置变量：Set()  
```
1.设置内置的变量：
same => n,Set(CALLERID(name)=John)

2.设置自定义变量：
same => n,Set(caller=John)
```

5.无条件跳转 和 条件跳转：Goto() 和 GotoIf()
```
1.跳转到上下文为 IVRMenu 的，并且在优先级1开始：
same => n,Goto(IVRMenu,1)

2.如果号码等于12345，则跳转到上下文A，否则跳转到B：
same => n,GotoIf($[${CALLERID(num)} = "12345"]?A:B)
```

6.接听呼叫：Answer()
```
处理来电，进行后续操作，例如 录音、播放ivr导航等：
exten => s,1,Answer()
```

7.等待：Wait()
```
等待1秒再进行下一步
exten => n,Wait(1)
```

8.录音：MixMonitor()
```
same => n,MixMonitor(${CALLFILENAME}.wav) ;
```


