## Rocky-Linux 9.4 安装asterisk、httpd、php编译环境
---
准备好安装包：  
<div style="background-color: rgb(206, 225, 225);  padding:20px; background-repeat: repeat;">
<div ><img src="汇总/学一招/img/1726297541655.jpg" alt=""><br>
</div>
</div>

### 1. 前置工作
1.关闭防火墙  
`systemctl stop firewalld.service`  
`systemctl disable firewalld.service`

2.更新为阿里云源  
```
sed -e 's|^mirrorlist=|#mirrorlist=|g' \
    -e 's|^#baseurl=http://dl.rockylinux.org/$contentdir|baseurl=https://mirrors.aliyun.com/rockylinux|g' \
    -i.bak \
    /etc/yum.repos.d/rocky*.repo
```
`yum install epel-release` 安装EPEL软件包（基于 RHEL 的系统提供额外的高质量软件包的项目）

3.更新软件仓库缓存  
`dnf makecache`

4.更新系统  
`yum update`


### 2.安装 编译环境 和 GD库
`yum groupinstall core base "Development Tools"`  
`yum install bison ncurses ncurses-devel zlib zlib-devel openssl openssl-devel gcc gcc-c++`  
`yum install gd gd-devel`  
`ldd /usr/lib64/libgd.so.3` 检查GD库安装，看下是否有 not found 的项  

### 3.安装 mysql
`yum install mysql mysql-server`  
`systemctl enable mysqld`  
`systemctl start mysqld`  
`systemctl status mysqld`  

`vi /etc/my.cnf`  
在 [client-server] 下面加一句：  
default-character-set=utf8  

`vi /etc/my.cnf.d/client.cnf`  
在 [client] 下面加一句：  
default-character-set=utf8  

在 [client-mariadb] 下面加一句：  
default-character-set=utf8  

`vi /etc/my.cnf.d/mysql-server.cnf`  
在 [mysqld]下面添加：  
```
datadir=/var/lib/mysql  
socket=/var/lib/mysql/mysql.sock  
log-error=/var/log/mysql/mysqld.log  
pid-file=/run/mysqld/mysqld.pid  

character-set-server=utf8
default-authentication-plugin=mysql_native_password
```

`systemctl restart mysqld`  重启mysql服务

### 4. 安装 asterisk
1.将所需安装包导入 opt，并且复制到 /tmp  
`cp /opt/pjproject-2.14.tar.bz2 /tmp/`   
`cp /opt/jansson-2.14.tar.bz2 /tmp/`  

2.解压安装  
`cd /opt`  
`tar zxvf asterisk-18.22.0.tar.gz`  
`cd asterisk-18.22.0`  
`contrib/scripts/install_prereq install`  执行脚本安装  

出现以下效果则 安装成功  
```
#############################################  
## install completed successfully  
#############################################  
```

3.配置软件  
`./configure --prefix=/usr/local/asterisk-18.22.0 --with-jansson-bundled`  配置软件编译选项，脚本运行成功后会生一个 Makefile 文件  

`make menuselect`  在Channel Drivers选项中选上chan_sip  

`make`  构建 Makefile 文件  
`make install`  
`make samples`  

`make config`  配置自启动会报错：We could not install init scripts for your distribution.  
`vim /usr/local/asterisk-18.22.0/etc/asterisk/modules.conf` 注释这句 ;noload = chan_sip.so  
`/usr/local/asterisk-18.22.0/sbin/safe_asterisk` 启动asterisk  
`netstat -tunap|grep asterisk`  查看连接信息，可以看到5060端口已经在侦听  

4.设置自启动  
`vi /lib/systemd/system/asterisk.service`  
添加以下内容：  
```
[Unit]
Description=Asterisk PBX and telephony daemon.
After=network.target

[Service]
Type=forking
EnvironmentFile=/usr/local/asterisk-18.22.0/etc/asterisk/asterisk.conf
WorkingDirectory=/usr/local/asterisk-18.22.0
#User=asterisk
#Group=asterisk
ExecStart=/usr/local/asterisk-18.22.0/sbin/safe_asterisk
ExecReload=/usr/local/asterisk-18.22.0/sbin/asterisk -rx 'core reload'
LimitCORE=infinity
Restart=always
RestartSec=4

# Prevent duplication of logs with color codes to /var/log/messages
StandardOutput=null

PrivateTmp=true

[Install]
WantedBy=multi-user.target
```
再执行两句：  
`dnf install chkconfig`  
`systemctl enable asterisk.service`  

5.修改  
`cd /usr/local/asterisk-18.22.0/etc/asterisk`  
`vi sip.conf`  
进入冒号模式并显示行号（在vi中执行 :set nu）  
第 132行 去掉注释  
第 224行 改为yes  

`vi /etc/profile`  在最后一行添加1句：PATH=$PATH:/usr/local/asterisk-18.22.0/sbin  
`source /etc/profile`  刷新系统变量配置  

6.在 /root 下配置软连接：  
`cd /root`  
`ln -s /usr/local/asterisk-18.22.0/etc/asterisk ast_config` 以后在root页面就能进入asterisk    

### 5. 安装 httpd
1.解压安装：  
`cd /opt`  
`wget https://www.openssl.org/source/old/1.0.2/openssl-1.0.2k.tar.gz`  
`tar zxvf openssl-1.0.2k.tar.gz`  
`cd openssl-1.0.2k`  
`./config -shared --prefix=/usr/local/openssl-1.0.2k`   
`make`  
`make install`  

2.配置软件：  
`cd /opt`  
`tar zxvf httpd-2.4.58.tar.gz`  

先将 apr-1.5.2.tar.gz 和 apr-util-1.5.4.tar.gz 解压，  
将apr-1.5.2目录复制且重命名为httpd-2.4.58/srclib/apr，  
将apr-util-1.5.4目录复制且重命名httpd-2.4.58/srclib/apr-util   
`tar -zxvf apr-1.5.2.tar.gz`  
`tar -zxvf apr-util-1.5.4.tar.gz`  
`cd httpd-2.4.58`  
`cp -r apr-1.5.2 httpd-2.4.58/srclib/apr`  
`cp -r apr-util-1.5.4 httpd-2.4.58/srclib/apr-util`  

`yum install pcre pcre-devel`  安装正则表达式库   

`cd /opt/httpd-2.4.58`  

配置软件编译选项：  
```
./configure --prefix=/usr/local/httpd-2.4.58 --enable-so --enable-cgi --enable-cgid --with-ssl=/usr/local/openssl-1.0.2k --enable-rewrite --with-pcre --with-z --with-included-apr --enable-modules=most --enable-mods-shared=most --enable-mpms-shared=all --with-mpm=event --enable-proxy --enable-proxy-fcgi --enable-expires --enable-deflate
```
`make`  
`make install`  

`vi /lib/systemd/system/httpd.service`  
添加以下内容：  
```
[Unit]
Description=httpd server
After=network.target

[Service]
Type=simple
EnvironmentFile=/usr/local/httpd-2.4.58/conf/httpd.conf
ExecStart=/usr/local/httpd-2.4.58/bin/apachectl -k start -DFOREGROUND
ExecReload=/usr/local/httpd-2.4.58/bin/apachectl -k graceful
ExecStop=/bin/kill -WINCH ${MAINPID}

[Install]
WantedBy=multi-user.target

```
`ps -ef | grep httpd` 查看是否安装成功  

`systemctl enable httpd.service`  
`systemctl start httpd.service`  

### 6. 安装 php
1.解压安装：  
`yum install curl libcurl-devel`  
`cd /opt`  
`tar zxvf php-5.6.40.tar.gz`  
`cd php-5.6.40`  
```
./configure --prefix=/usr/local/php-5.6.40 --with-apxs2=/usr/local/httpd-2.4.58/bin/apxs --with-config-file-path=/usr/local/php-5.6.40 --enable-mbstring --with-libxml-dir --with-zlib --with-freetype-dir --with-gd --enable-gd-native-ttf --with-jpeg-dir --with-png-dir --with-mysql --with-pdo-mysql --with-curl --enable-zip --with-ssl=/usr/local/openssl-1.0.2k
```
`make`  
`make install`  

`vi /etc/profile`  在最后一行添加1句：PATH=$PATH:/usr/local/php-5.6.40/bin   
`source /etc/profile`

`php -v` 查看是否安装成功  
