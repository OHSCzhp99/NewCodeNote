## Mycat 搭建集群/心跳检测/故障切换
---
准备好安装包：  
<div style="background-color: rgb(206, 225, 225);  padding:20px; background-repeat: repeat;">
<div ><img src="汇总/学一招/img/1726301126868.jpg" alt=""><br>
</div>
</div>

### 1. 安装 jdk
Mycat 基于 jdk1.8开发，先安装jdk环境：  
`dnf -y install java-1.8.0-openjdk.x86_64`  
`java -version` 查看jdk版本  

### 2. 安装 Mycat2
1.创建 /data/tools：  
`mkdir -p /data/tools`  
2.进入：  
`cd /data/tools`  
3.拖进两个安装包到 tools 目录：  
4.解压并且放到上一级 data 目录下：  
`yum -y install unzip`  
`unzip mycat2-install-template-1.21.zip`    
`mv mycat ../`  
5.修改 mycat/bin 的权限：  
`cd /data/mycat/bin`   
`chmod +x *`  （bin中的文件将变为绿色）  
6.将原本的jar包放到 mycat/lib 目录下：  
`cd /data/mycat/lib`  
`cp /data/tools/mycat2-1.22-release-jar-with-dependencies.jar ./`  

Mycat的文件：（我们主要关注 conf 配置文件）
<div style="background-color: rgb(206, 225, 225);  padding:20px; background-repeat: repeat;">
<div ><img src="汇总/学一招/img/1724724602748.jpg" alt=""><br>
</div>
</div>

### 3. 配置物理库地址
启动之前Mycat我们要配置物理库的地址，要不然会Mycat报错，  
配置文件位置：/data/mycat/conf/datasources/prototypeDs.datasource.json 

1.编辑数据库配置文件：  
`vim /data/mycat/conf/datasources/prototypeDs.datasource.json`  
2.主要修改用户名、密码、数据库ip地址：（注意这里是密码在上面用户在下面别填错）  
<div style="background-color: rgb(206, 225, 225);  padding:20px; background-repeat: repeat;">
<div ><img src="汇总/学一招/img/1724725767090.jpg" alt=""><br>
</div>
</div>

### 4. 启动 Mycat2
1.进入 mycat/bin：  
`cd /data/mycat/bin`  
2.启动 mycat：
`./mycat start`  
3.查看进程和日志：  
`ps -ef|grep mycat`  
`tail -n 10 /data/mycat/logs/wrapper.log`  

### 5. 连接 Mycat2
1.查看 mycat 密码：  
`cd /data/mycat/conf/users`  
`cat root.user.json`  
2.连接 mycat：  
输入mycat所在服务器的ip地址，端口号是8066
<div style="background-color: rgb(206, 225, 225);  padding:20px; background-repeat: repeat;">
<div ><img src="汇总/学一招/img/1724726949116.jpg" alt=""><br>

<img src="汇总/学一招/img/1724727055632.jpg" alt=""><br>
</div>
</div>

### 6. 配置 一主一从一备
m1 为主节点  
m2 为从节点，并且充当备节点  

正常情况：  
写在m1，读在m1、m2，因为 Mycat 自动实现负载均衡   

宕机情况：   
① m1宕机：将失去原本的负载均衡效果，m2会接管，此时读写都在m2   
② m2宕机：将失去原本的负载均衡效果，读写都在m1  

##### 下面会具体介绍各个目录并且配置m1、m2节点  

### 6.1 目录解读 - datacource
数据源：连接数据库的配置  
路径：mycat/conf/datasources  
文件名：默认 prototypeDs.datasource.json  
<div style="background-color: rgb(206, 225, 225);  padding:20px; background-repeat: repeat;">
<div ><img src="汇总/学一招/img/1725330132211.jpg" alt=""><br>
</div>
</div>

一主一从一备，改 instanceType、name、url、password、user
m1和m2的instanceType 都为 READ_WRITE
```
1.创建数据源： 
m1节点：
/* + mycat:createDataSource{
    "dbType":"mysql",
    "idleTimeout":60000,
    "initSqls":[],
    "initSqlsGetConnection":true,
    "instanceType":"READ_WRITE",
    "maxCon":1000,
    "maxConnectTimeout":3000,
    "maxRetryCount":5,
    "minCon":1,
    "name":"m1",
    "password":"root",
    "type":"JDBC",
    "url":"jdbc:mysql://192.168.121.121:3306/mysql?useUnicode=true&serverTimezone=Asia/Shanghai&characterEncoding=UTF-8",
    "user":"root",
    "weight":0
} */

m2节点：
/* + mycat:createDataSource{
    "dbType":"mysql",
    "idleTimeout":60000,
    "initSqls":[],
    "initSqlsGetConnection":true,
    "instanceType":"READ_WRITE",
    "maxCon":1000,
    "maxConnectTimeout":3000,
    "maxRetryCount":5,
    "minCon":1,
    "name":"m2",
    "password":"root",
    "type":"JDBC",
    "url":"jdbc:mysql://192.168.121.124:3306/mysql?useUnicode=true&serverTimezone=Asia/Shanghai&characterEncoding=UTF-8",
    "user":"root",
    "weight":0
} */

2.查看数据源：
/* + mycat:showDataSources{} */
```

### 6.2 目录解读 - clusters
数据源：集群配置   
路径：mycat/conf/clusters    
文件名：默认 prototype.cluster.json  
<div style="background-color: rgb(206, 225, 225);  padding:20px; background-repeat: repeat;">
<div ><img src="汇总/学一招/img/1725330699680.jpg" alt=""><br>
</div>
</div>

clusterType：是集群类型  
masters：主节点（读写）   
replicas：从节点（只读）  
timer：心跳检测  
```
1.创建集群：
/*! mycat:createCluster{
	"clusterType":"MASTER_SLAVE",
	"heartbeat":{
		"heartbeatTimeout":1000,
		"maxRetry":3,
		"minSwitchTimeInterval":300,
		"slaveThreshold":0
	},
	"masters":[ 
		"m1","m2"
	],
  	"replicas":[
		"m2"
	],
	"maxCon":200,
	"name":"prototype",
	"readBalanceType":"BALANCE_ALL",
	"switchType":"SWITCH" ,
	"timer":{
		"initialDelay": 5,
		"period":5,
		"timeUnit":"SECONDS"
	}
} */

2.删除集群：
/*! mycat:dropCluster{
	"name":"prototype"
} */

3.查看集群：
/*+ mycat:showClusters{} */
```

### 6.3 目录解读 - schemas
逻辑库：逻辑库、逻辑表配置   
路径：mycat/conf/schemas    
文件名：默认 mysql.schemas.json  
<div style="background-color: rgb(206, 225, 225);  padding:20px; background-repeat: repeat;">
<div >

需要手动直接修改 *.schemas.json配置文件，手动添加指定集群，需要重启mycat：<br>
<img src="汇总/学一招/img/1725331781022.jpg" alt=""><br>

添加逻辑表后 *.schemas.json配置文件就会这样：<br>
<img src="汇总/学一招/img/1725332189606.jpg" alt=""><br>
</div>
</div>


```
1.创建逻辑库：
create database mycatTest default character set utf8mb4 collate utf8mb4_general_ci;

2.创建逻辑表：
use mycatTest
CREATE TABLE `class` (
  `id` INT NOT NULL AUTO_INCREMENT,
  `time` DATETIME,
  PRIMARY KEY (`id`)
);
```

### 7. 测试
1.返回上面启动 Mycat 的步骤，手动停掉 m1、m2 的数据库，看看是否打到效果  

