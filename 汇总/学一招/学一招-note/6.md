## Mysql 主从复制
---

### *常用的设置和查询命令：
`tail -n 10 /var/log/mysql/mysqld.log;`  查看错误日志(操作失败后，关注日志)   
`tail -n 10 /var/log/mariadb/mariadb.log;`  查看错误日志(操作失败后，关注日志 - mariadb)  
`show variables like 'validate_password%';`  查看密码安全规则  
`alter user 'root'@'localhost' identified by 'abc*123';` 修改用户密码  
`flush privileges;` 刷新权限   
 
`select user, host, plugin from mysql.user;`  查看用户的认证插件  
`show grants for 'rootms'@'192.168.121.124';`  查看该用户的权限  

### *问题汇总：（导致两个线程都不为 Yes 的原因）
1.配置文件问题，一再检查，如果没写错就看下面的问题    
2.系统时间问题，确保各个服务器的时间是同步  
3.创建复制用户的问题  
问题：使用了认证插件为 caching_sha2_password   
解决：修改为 mysql_native_password   
`show grants for 'rootms'@'192.168.121.124';`  
4.其他问题  
问题：主库的二进制日志中出现了 GRANT 语句，导致从库权限不足无法执行而终止sql进程  
（具体为什么有 GRANT 语句我也不知道什么原因，是从mysql日志中得知的）   
解决：将主库备份好数据后，在主和从库上执行二进制日志清空   
`reset master`  

由于Mysql和Maria的写法其实有很多不同：（要注意写法）  
问题：出现gtid不在主库上  
解决：复制的时候，    
采用 MASTER_LOG_FILE='localhost-bin.000001',MASTER_LOG_POS=151217;  
这样可以指定gtid位置  

问题：出现gtid乱序  
解决：复制的时候，   
采用 master_use_gtid=slave_pos;    
跟上面的反过来就行  
---
### 1. 关闭防火墙和核心防护
`systemctl stop firewalld`  
`setenforce 0`  


### 2. 服务器的时间一致
`sudo yum install chrony`  安装  
`sudo systemctl start chronyd`  启动  
`sudo systemctl enable chronyd`  开机自启  
`chronyc -a makestep` 更新时间  
不行的话更新系统  
`dnf update`  

### 3. 配置节点服务器
1.修改配置文件 /etc/my.cnf：  
`vim /etc/my.cnf`   
2.添加内容：  
主从服务器都添加以下内容，不过server-id 要不同，可一个为1一个为2  
```mysql
这是mysql的写法：(主从都这样写，从改server-id为2就行)
[mysqld]
server-id = 1  #MySQL服务器设置一个唯一的服务器id
log-bin = mysql-bin  #开启二进制并命名前缀为mysql-bin
log-bin-index=mysql-bin.index  #指定二进制日志索引，方便
gtid_mode = on  #开启gtid，复制更可靠
enforce_gtid_consistency = on  #强制gtid一致
binlog_format = row  #更精准的复制，消耗资源
require_secure_transport=0	#关闭加密连接进行数据传输
```

```maria
这是maria的写法：(主从都这样写，从改server-id为2就行)
[mysqld]
log-bin
server-id=1
binlog_format=row #二进制记录方式，更安全
log-slave-updates=1 #从节点将会保存主节点的二进制 到 从节点自己的二进制文件中
gtid_strict_mode=1 #严格模式，确保每次事务被执行一次
slave_parallel_threads=4 #4个线程用于复制
master-verify-checksum=1 #这有助于确保二进制日志数据的完整性
```

3.主从重启服务器：  
`systemctl restart mysqld`  
4.主从都要创建复制用户：   
mysql写法：  
`CREATE USER 'rootms'@'%' IDENTIFIED WITH mysql_native_password BY 'root';`  
`GRANT REPLICATION SLAVE ON *.* TO 'rootms'@'%';`  
`flush privileges;`  
maria写法：   
`CREATE USER 'rootms'@'%' IDENTIFIED BY 'root';`  
`GRANT REPLICATION SLAVE ON *.* TO 'rootms'@'%';`  
`flush privileges;`   
5.（可选）查看和删除 Mysql 用户：  
`SELECT user, host FROM mysql.user;`  
`DROP USER 'rootms'@'%';`  

6.检查gtid模式状态：（gtid_mode 和 enforce_gtid_consistency 是否为 ON）  
`show  variables like '%gtid%';` 

<div style="background-color: rgb(206, 225, 225);  padding:20px; background-repeat: repeat;">
<div ><img src="汇总/学一招/img/1725519933941.jpg" alt=""><br>
</div>
</div>

<!-- 7.查看二进制日志坐标：（我们用GTID，就不用查看坐标了，会自动记录）  
`show master status;`  
file : 从哪个日志文件开始推送日志文件，即我们写到哪个日志文件了  
position： 从哪个位置开始推送日志，稍后我们只需要从当前这个日志文件的这个位置往后再来同步就行了

<div style="background-color: rgb(206, 225, 225);  padding:20px; background-repeat: repeat;">
<div ><img src="汇总/学一招/img/1724729002900.jpg" alt=""><br>
</div>
</div> -->

7.配置同步，主从都要：（根据实际更改：ip，假设主为121、从为124）  
`stop slave;`  停止复制  
`reset slave all;` 清空复制  
在主节点连接从的复制用户：  
`CHANGE MASTER TO MASTER_HOST='192.168.121.124', MASTER_USER='rootms',MASTER_PASSWORD='root', MASTER_PORT=3306, MASTER_AUTO_POSITION = 1;` 

在从节点连接主的复制用户：  
`CHANGE MASTER TO MASTER_HOST='192.168.121.121', MASTER_USER='rootms',MASTER_PASSWORD='root', MASTER_PORT=3306, MASTER_AUTO_POSITION = 1;`  

```
maria写法：
CHANGE MASTER TO  
    MASTER_HOST='10.160.0.21',  
    MASTER_USER='rootms',  
    MASTER_PASSWORD='root',  
    MASTER_PORT=3306,  
    MASTER_LOG_FILE='localhost-bin.000001',
    MASTER_LOG_POS=348545;

CHANGE MASTER TO  
    MASTER_HOST='10.160.0.21',  
    MASTER_USER='rootms',  
    MASTER_PASSWORD='root',  
    MASTER_PORT=3306,  
    master_use_gtid=slave_pos;
```

`start slave;`  开启复制  

8.查看两个重要的信息是否为 Yes：   
`show slave status\G`  
Slave_IO_Running: Yes   负责与主机的io通信  
Slave_SQL_Running: Yes   负责自己的slave mysql进程  
<div style="background-color: rgb(206, 225, 225);  padding:20px; background-repeat: repeat;">
<div ><img src="汇总/学一招/img/1724746221122.jpg" alt=""><br>
</div>
</div>

### 4. 测试
1.在主库输入：  
```
create database school;
use school;
create table class(id int(3) primary key,name varchar(10),address varchar(50));
show tables;
```
2.在从库输入：（看看是否有更新）  
`show tables;`

## Keepalived 高可用（政务不可用）
---
### 1. Keepalived
Keepalived是一个轻量级别的高可用解决方案，通过虚拟IP（VIP）对多个服务器进行“包装”，  
我们只需要访问VIP就可访问服务器，即对应用程序透明   

Keepalived监控集群系统中各个服务节点的状态，某个服务器节点出现异常，  
Keepalived将检测到、并将出现的故障的服务器节点从集群系统中剔除，VIP将指向其他节点

### 2. 安装 Keepalived
以下操作均在所有服务器节点上操作：  

1.安装 httpd 服务：（测试用的，非必须）  
`yum install httpd -y`  
`echo master > /var/www/html/index.html`  在master节点上执行   
`echo slave > /var/www/html/index.html`  在slave节点上执行   
`systemctl start httpd`  

2.安装 Keepalived 服务：  
`yum install keepalived -y`  
`vim /etc/keepalived/keepalived.conf`  更改配置文件内容（复制内容时删掉注释）
```
master的keepalived.conf：---------------------
#!/usr/local/bin/keepalived

global_defs {
    router_id LVS_DEVEL
}

vrrp_instance VI_1 {
    state MASTER   #表示该节点为master
    interface ens33  #指定网卡
    virtual_router_id 51  #集群下id必须一致，所有服务器节点id必须相同
    priority 100  #优先级
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 1111
    }
    track_interface {
        ens33
    }
    virtual_ipaddress {
        192.168.121.50/24 dev ens33 label ens33:1  #指定VIP
    }
}

slave的keepalived.conf：---------------------
#!/usr/local/bin/keepalived

global_defs {
    router_id LVS_DEVEL
}

vrrp_instance VI_1 {
    state BACKUP
    interface ens33
    virtual_router_id 51
    priority 90
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 1111
    }
    track_interface {
        ens33
    }
    virtual_ipaddress {
        192.168.121.50/24 dev ens33 label ens33:1
    }
}
```
`systemctl start keepalived`  
`systemctl enable keepalived`   
`systemctl status keepalived`  查看状态  
3.简单测试：  
`ip a`  查看ens33网卡是否已经加载虚拟ip   
因为master存活，所以虚拟ip加载在master，如果master宕机，则优先级高的slave会加载虚拟ip  
<div style="background-color: rgb(206, 225, 225);  padding:20px; background-repeat: repeat;">
<div ><img src="汇总/学一招/img/1725002583543.jpg" alt=""><br>
</div>
</div>

`curl 192.168.121.50`  将输出 master，因为此时master存活（master宕机将输出slave）

### 3. 测试 - 每秒连接数据库
1.在win系统写个bat脚本，每秒监控虚拟ip的Mysql的连接情况：  
```
@echo off  
setlocal  
  
set "DB_HOST=192.168.121.50"  ::虚拟ip
set "DB_PORT=3306"  ::端口号
set "DB_USER=root"  ::账号
set "DB_PASS=db*123456"  ::密码
set "DB_NAME=zhp"  ::数据库
  
:loop  
mysql -h %DB_HOST% -P %DB_PORT% -u %DB_USER% -p%DB_PASS% -e "SELECT 1" %DB_NAME% >nul 2>&1  
if %errorlevel% equ 0 (  
    echo ok  
) else (  
    echo no  
)  
timeout /t 1 >nul  
goto loop
```
2.将脚本打开，会持续每秒输出 OK，  
再将master服务器关机，此时会停顿3秒左右重新输出OK，则虚拟ip已经加载到slave上


### 4. 测试 - 故障转移
1.在win系统写两个个bat脚本，每秒监控插入和输出，看数据是否正确：  
```
插入脚本：----------------------------
@echo off  
setlocal  
  
set "DB_HOST=192.168.121.50"  
set "DB_PORT=3306"  
set "DB_USER=root"  
set "DB_PASS=db*123456"  
set "DB_NAME=zhp"  
  
:loop  
for /f "tokens=2 delims==" %%I in ('wmic OS Get localdatetime /value') do set datetime=%%I  
set datetime=%datetime:~0,8%:%datetime:~8,6%  
  
mysql -h %DB_HOST% -P %DB_PORT% -u %DB_USER% -p%DB_PASS% -e "INSERT INTO test (time) VALUES (NOW());" %DB_NAME%  
if %errorlevel% equ 0 (  
    echo YES at %datetime%  
) else (  
    echo NO  
)  
timeout /t 1 >nul  
goto loop

输出脚本：----------------------------
@echo off
setlocal

set "DB_HOST=192.168.121.50"
set "DB_PORT=3306"
set "DB_USER=root"
set "DB_PASS=db*123456"
set "DB_NAME=zhp"

:loop
curl 192.168.121.50
mysql -h %DB_HOST% -P %DB_PORT% -u %DB_USER% -p%DB_PASS% -e "SELECT * FROM test ORDER BY id DESC LIMIT 4;" %DB_NAME%
timeout /t 1 >nul
goto loop
```
2.运行这两个脚本，出现两个控制台窗口将实时监控和输出，过程中将 master 节点关机，  
会停顿5秒左右，等切换会 slave 节点，就会重新监控输出了  

<!-- ## MHA 高可用
---
### 1. MHA
1.作用：监控主节点的状态，主宕机，会自动将拥有最新数据的从节点提升为新的主节点  
2.角色：MHA Manager（管理节点）和 MHA Node（数据节点）   
MHA Manager 通常部署在独立的机器上（这里我们将部署在从节点上）   
MHA Node 则是数据库节点

### 2. MHA 安装
1.在所有服务器上安装依赖环境：  
`yum -y install epel-release` 安装 epel 源    
`yum install -y perl-DBD-MySQL`   
`yum install -y perl-Config-Tiny`  
`yum install -y perl-Log-Dispatch --skip-broken`  
`yum install -y perl-Parallel-ForkManager --skip-broken`  
`yum install -y perl-ExtUtils-CBuilder`  
`yum install -y perl-ExtUtils-MakeMaker`  
`yum install -y perl-CPAN` 

以下是可能会缺失的包，也安装一下吧：  
`wget -O - https://cpanmin.us | perl - App::cpanminus` 安装cpanminus  
`cpanm inc::Module::Install`   下面执行 perl Makefile.PL 时可能会用到  
2.安装 MHA 所需的 node组件 和 manager组件：（下载好后拖进 /opt）      
node组件：  
https://github.com/yoshinorim/mha4mysql-node/releases/download/v0.58/mha4mysql-node-0.58.tar.gz    
manager组件：  
https://github.com/yoshinorim/mha4mysql-manager/releases/download/v0.58/mha4mysql-manager-0.58.tar.gz  
3.在所有服务器上解压node组件：  
`cd /opt`  
`tar zxvf mha4mysql-node-0.58.tar.gz`  
`cd  mha4mysql-node-0.58/`  
`perl Makefile.PL`  
`make && make install`  
4.在master服务器上解压manager组件：    
`cd /opt`  
`tar zxvf mha4mysql-manager-0.58.tar.gz`  
`cd mha4mysql-manager-0.58/`  
`perl Makefile.PL`  
`make && make install`  

### 3. MHA 配置
1.在master节点上配置所有节点ssh无密码认证：  
`ssh-keygen -t rsa` 一直按回车键最后会出现一串密钥   
`ssh-copy-id 192.168.121.124`  配置免密登录，回车输入yes，输入从服务器的密码  
`ssh 192.168.121.124`  输入从服务器的ip（如果有多个slave，则继续ssh多个）     
2.在slave节点上配置所有节点ssh无密码认证：  
`ssh-keygen -t rsa` 一直按回车键最后会出现一串密钥   
`ssh-copy-id 192.168.121.121`  配置免密登录，回车输入yes，输入主服务器的密码  
`ssh 192.168.121.121`  输入主服务器的ip（如果有多个slave，则继续ssh多个）  
3.在 master 节点上复制相关脚本到 /usr/local/bin 目录：（配置虚拟ip，简称VIP）  
`cp mha4mysql-manager-0.58/samples/scripts/* /usr/local/bin/`   
`vim /usr/local/bin/master_ip_failover`  
添加如下内容：（放在my() 和 GetOptions()的中间）
```
#############################添加内容部分############################
my $vip = '192.168.121.120'; #指定vip的地址
my $brdc = '192.168.121.255';  #指定vip的广播地址
my $ifdev = 'ens33';  #指定vip绑定的网卡
my $key = '1';    #指定vip绑定的虚拟网卡序列号
my $ssh_start_vip = "/sbin/ifconfig ens33:$key $vip";   #代表此变量值为ifconfig ens33:1 192.168.10.100
my $ssh_stop_vip = "/sbin/ifconfig ens33:$key down";    #代表此变量值为ifconfig ens33:1 192.168.10.100 down
my $exit_code = 0;                                              #指定退出状态码为0

#my $ssh_start_vip = "/usr/sbin/ip addr add $vip/24 brd $brdc dev $ifdev label $ifdev:$key;/usr/sbin/arping -q -A -c 1 -I $ifdev $vip;iptables -F;";
#my $ssh_stop_vip = "/usr/sbin/ip addr del $vip/24 dev $ifdev label $ifdev:$key";
#####################################################################
```
<div style="background-color: rgb(206, 225, 225);  padding:20px; background-repeat: repeat;">
<div ><img src="汇总/学一招/img/1724917135042.jpg" alt=""><br>
</div>
</div>

4.创建 MHA 软件目录并拷贝配置文件：  
`mkdir /etc/masterha`  
`cp /opt/mha4mysql-manager-0.58/samples/conf/app1.cnf /etc/masterha/`  
`vim /etc/masterha/app1.cnf`  
① 先查找master的binlog文件路径：  
`SHOW VARIABLES LIKE 'datadir';` Value就是路径，我的是 /var/lib/mysql/  
② 主要更改：  
master_binlog_dir    
user、password  
repl_user、repl_password  
secondary_check_script  
[server1]、[server2]...（如果还有server3）   
```
[server default]
manager_log=/var/log/masterha/app1/manager.log            #manager日志
manager_workdir=/var/log/masterha/app1                    #manager工作目录
master_binlog_dir= /var/lib/mysql/                   #master保存binlog的位置，这里的路径要与master里配置的binlog的路径一致，以便MHA能找到
master_ip_failover_script=/usr/local/bin/master_ip_failover #设置自动failover时候的切换脚本，也就是上面的那个脚本
master_ip_online_change_script=/usr/local/bin/master_ip_online_change #设置手动切换时候的切换脚本
user=mha            #设置mysql用户,manager用户名
password=manager     #设置mysql用户的密码，manager密码
ping_interval=1  #设置监控主库，发送ping包的时间间隔，默认是3秒，尝试三次没有回应的时候自动进行failover
remote_workdir=/tmp #设置远端mysql在发生切换时binlog的保存位置
repl_user=myslave  #主从复制时设置的用户
repl_password=123456 #主从复制时设置的密码
secondary_check_script=/usr/local/bin/masterha_secondary_check -s 192.168.121.124 -s 192.168.121.125  #指定检查的从服务器IP地址
shutdown_script=""  #设置故障发生后关闭故障主机脚本（该脚本的主要作用是关闭主机防止发生脑裂,这里没有使用）
ssh_user=root       #设置ssh的登录用户名
 
[server1]
hostname=192.168.121.121
port=3306

[server2]
hostname=192.168.121.124
port=3306
candidate_master=1 #候选master，就算不是最新的slave
```

5.在master上手动开启VIP：  
`/sbin/ifconfig ens33:1 192.168.121.120/24`   
`ip a`   

<div style="background-color: rgb(206, 225, 225);  padding:20px; background-repeat: repeat;">
<div ><img src="汇总/学一招/img/1724919787449.jpg" alt=""><br>
</div>
</div> -->